<!-- agent.conf - Centralized Agent Configuration -->
<agent_config>

  <!-- POLICY MONITORING -->
  <rootcheck>
    <disabled>no</disabled>
    <check_files>yes</check_files>
    <check_trojans>yes</check_trojans>
    <check_dev>yes</check_dev>
    <check_sys>yes</check_sys>
    <check_pids>yes</check_pids>
    <check_ports>yes</check_ports>
    <check_if>yes</check_if>
    <frequency>28800</frequency>
    <rootkit_files>etc/shared/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>etc/shared/rootkit_trojans.txt</rootkit_trojans>
    <skip_nfs>yes</skip_nfs>
    <!-- Universal ignores -->
    <ignore>/var/lib/kubelet</ignore>
    <ignore>/var/lib/containerd</ignore>
    <ignore>/var/lib/docker/overlay2</ignore>
    <ignore>/snap</ignore>
    <ignore>/var/lib/snapd</ignore>
    <ignore>/proc</ignore>
    <ignore>/sys</ignore>
  </rootcheck>

  <!-- SECURITY CONFIGURATION ASSESSMENT -->
  <sca>
    <enabled>yes</enabled>
    <scan_on_start>yes</scan_on_start>
    <interval>8h</interval>
    <skip_nfs>yes</skip_nfs>
  </sca>

  <!-- FILE INTEGRITY MONITORING -->
  <syscheck>
    <disabled>no</disabled>
    <frequency>21600</frequency>
    <scan_on_start>yes</scan_on_start>

    <!-- Universal Critical System Directories -->
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/ssl</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/usr/bin</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/usr/sbin</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/bin</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/sbin</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/boot</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/usr/local/bin</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/usr/local/sbin</directories>
    
    <!-- Universal User and Application Directories -->
    <directories check_all="yes" realtime="yes" report_changes="yes">/root</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/home</directories>
    <directories check_all="yes" realtime="no" report_changes="yes">/var/www</directories>
    <directories check_all="yes" realtime="no" report_changes="yes">/opt</directories>
    
    <!-- Universal System Configuration -->
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/ssh</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/pam.d</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/sudoers.d</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/cron.d</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/cron.daily</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/cron.weekly</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/cron.monthly</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/systemd/system</directories>

    <!-- Package management (universal) -->
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/apt</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/yum.repos.d</directories>

    <!-- Multi-OS specific directories (will only monitor if they exist) -->
    <directories check_all="yes" realtime="no" report_changes="yes">/etc/apparmor.d</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/ufw</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/netplan</directories>
    <directories check_all="yes" realtime="no" report_changes="yes">/etc/update-motd.d</directories>
    <directories check_all="yes" realtime="yes" report_changes="yes">/etc/firewalld</directories>

    <!-- Universal files to ignore -->
    <ignore>/etc/mtab</ignore>
    <ignore>/etc/resolv.conf</ignore>
    <ignore>/etc/machine-id</ignore>
    <ignore>/etc/adjtime</ignore>
    <ignore>/etc/ld.so.cache</ignore>
    <ignore>/var/lib/apt/lists</ignore>
    <ignore>/var/cache/apt</ignore>
    <ignore>/var/lib/dpkg/lock-frontend</ignore>
    <ignore>/var/lib/dpkg/lock</ignore>
    <ignore>/var/cache/yum</ignore>
    <ignore>/var/cache/dnf</ignore>
    <ignore>/var/lib/kubelet</ignore>

    <!-- File types to ignore -->
    <ignore type="sregex">.log$|.swp$|.tmp$|~$</ignore>

    <!-- Universal sensitive files - no diff -->
    <nodiff>/etc/shadow</nodiff>
    <nodiff>/etc/gshadow</nodiff>
    <nodiff>/etc/ssl/private.key</nodiff>

    <!-- Universal skip settings -->
    <skip_nfs>yes</skip_nfs>
    <skip_dev>yes</skip_dev>
    <skip_proc>yes</skip_proc>
    <skip_sys>yes</skip_sys>

    <!-- Performance Settings -->
    <process_priority>10</process_priority>
    <max_eps>100</max_eps>

    <!-- Database synchronization -->
    <synchronization>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <max_eps>20</max_eps>
    </synchronization>
  </syscheck>

  <!-- UNIVERSAL LOG MONITORING -->
  <!-- Rocky Linux logs -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/messages</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/secure</location>
  </localfile>

  <!-- Ubuntu/Debian logs -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/syslog</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/auth.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/kern.log</location>
  </localfile>

  <!-- Universal logs -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/cron</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/cron.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/mail.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/maillog</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/daemon.log</location>
  </localfile>

  <!-- Firewall logs (multi-OS) -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/ufw.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/firewalld</location>
  </localfile>

  <!-- Active responses -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/ossec/logs/active-responses.log</location>
  </localfile>

  <!-- Ubuntu specific logs -->
  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/unattended-upgrades/unattended-upgrades.log</location>
  </localfile>

  <!-- UNIVERSAL COMMAND MONITORING -->
  <localfile>
    <log_format>full_command</log_format>
    <command>netstat -tulpn | sed 's/\([[:alnum:]]\+\)\ \+[[:digit:]]\+\ \+[[:digit:]]\+\ \+\(.*\):\([[:digit:]]*\)\ \+\([0-9\.\:\*]\+\).\+\ \([[:digit:]]*\/[[:alnum:]\-]*\).*/\1 \2 == \3 == \4 \5/' | sort -k 4 -g | sed 's/ == \(.*\) ==/:\1/' | sed 1,2d</command>
    <alias>netstat_listening_ports</alias>
    <frequency>300</frequency>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>last -n 15</command>
    <frequency>300</frequency>
    <alias>last_logged_users</alias>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -15</command>
    <frequency>300</frequency>
    <alias>top_processes</alias>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>ss -tuln</command>
    <frequency>300</frequency>
    <alias>network_connections</alias>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>getent passwd | cut -d: -f1,3,6,7 | grep -E ':[0-9]{4}:' | sort -t: -k2 -n</command>
    <frequency>3600</frequency>
    <alias>system_users</alias>
  </localfile>

  <!-- UNIVERSAL SYSTEM MONITORING -->
  <localfile>
    <log_format>full_command</log_format>
    <command>systemctl --failed --no-legend | wc -l</command>
    <frequency>300</frequency>
    <alias>failed_services</alias>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>who -b</command>
    <frequency>600</frequency>
    <alias>system_boot_time</alias>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>systemctl list-units --type=service --state=running --no-legend | wc -l</command>
    <frequency>300</frequency>
    <alias>running_services_count</alias>
  </localfile>

  <!-- UNIVERSAL SECURITY MONITORING -->
  <localfile>
    <log_format>full_command</log_format>
    <command>find /etc -name "*.conf" -type f -mtime -1 2>/dev/null | head -10</command>
    <frequency>3600</frequency>
    <alias>recent_config_changes</alias>
  </localfile>

  <!-- Multi-OS authentication monitoring -->
  <localfile>
    <log_format>full_command</log_format>
    <command>journalctl --since "1 hour ago" | grep -i "failed\|authentication failure" | wc -l</command>
    <frequency>300</frequency>
    <alias>auth_failures_journald</alias>
  </localfile>

  <!-- Package management monitoring (works on all systems) -->
  <localfile>
    <log_format>full_command</log_format>
    <command>which apt >/dev/null 2>&1 && apt list --upgradable 2>/dev/null | grep -v "WARNING" | wc -l || echo "0"</command>
    <frequency>3600</frequency>
    <alias>available_updates_apt</alias>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>which yum >/dev/null 2>&1 && yum check-update --quiet | wc -l || echo "0"</command>
    <frequency>3600</frequency>
    <alias>available_updates_yum</alias>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>which dnf >/dev/null 2>&1 && dnf check-update --quiet | wc -l || echo "0"</command>
    <frequency>3600</frequency>
    <alias>available_updates_dnf</alias>
  </localfile>

  <!-- Firewall monitoring (multi-OS) -->
  <localfile>
    <log_format>full_command</log_format>
    <command>which ufw >/dev/null 2>&1 && ufw status numbered | grep -E "\[.*\]" | head -10 || echo "ufw not available"</command>
    <frequency>600</frequency>
    <alias>firewall_rules_ufw</alias>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>which firewall-cmd >/dev/null 2>&1 && firewall-cmd --list-all | head -10 || echo "firewalld not available"</command>
    <frequency>600</frequency>
    <alias>firewall_rules_firewalld</alias>
  </localfile>

</agent_config>
